<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Simple Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Minimal clean styles */
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa7bb; --accent:#3b82f6; --accent-2:#06b6d4;
      --txt:#ecf0f7;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021, #081426);color:var(--txt)}
    .wrap{max-width:1100px;margin:24px auto;padding:18px;display:grid;grid-template-columns:320px 1fr;gap:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .sidebar{display:flex;flex-direction:column;height:82vh}
    .brand{font-weight:700;font-size:20px;margin-bottom:8px;color:var(--accent)}
    .user-control{margin-bottom:12px}
    input[type="text"].username{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--txt)}
    button{cursor:pointer;padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:white;font-weight:600}
    .users-list{flex:1;overflow:auto;margin-top:8px;padding:8px;border-radius:8px;border:1px dashed rgba(255,255,255,0.02)}
    .users-list .user{padding:6px 8px;border-radius:6px;margin-bottom:6px;background:rgba(255,255,255,0.01);display:flex;justify-content:space-between;align-items:center}
    .chat-area{display:flex;flex-direction:column;height:82vh}
    .messages{flex:1;overflow:auto;padding:12px;border-radius:12px;border:1px dashed rgba(255,255,255,0.02);margin-bottom:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .msg{margin-bottom:10px}
    .msg .meta{font-size:12px;color:var(--muted)}
    .msg .text{background:rgba(255,255,255,0.03);display:inline-block;padding:8px 10px;border-radius:8px;margin-top:4px;max-width:80%}
    .msg.me .text{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#022}
    .controls{display:flex;gap:8px}
    input[type="text"].message{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--txt)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .typing{font-size:13px;color:var(--muted);height:18px}
    .system{font-size:13px;color:var(--muted);font-style:italic;margin-bottom:8px}
    .private-badge{font-size:11px;background:#2b3440;padding:4px 6px;border-radius:6px;color:var(--muted);margin-left:8px}
    .top-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .logo{font-size:18px;font-weight:700;color:var(--accent)}
    @media (max-width:880px){.wrap{grid-template-columns:1fr;padding:12px}.sidebar{order:2;height:auto}.chat-area{order:1;height:72vh}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card sidebar">
      <div class="brand"><span class="logo">Chatterbox</span> — realtime</div>

      <div class="user-control">
        <label style="font-size:13px;color:var(--muted)">Choose a username</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="usernameInput" class="username" placeholder="your display name" maxlength="32" />
          <button id="setUsernameBtn">Join</button>
        </div>
        <div class="hint">Private messages: start a message with <code>@username message</code></div>
      </div>

      <div class="top-info" style="margin-bottom:6px">
        <div style="font-size:13px;color:var(--muted)">Online</div>
        <div style="font-size:12px;color:var(--muted)" id="onlineCount">0</div>
      </div>

      <div class="users-list card" id="usersList" aria-live="polite"></div>

      <div style="margin-top:10px;font-size:12px;color:var(--muted)">
        Built for demo. Refresh to reconnect. No account required.
      </div>
    </div>

    <div class="card chat-area">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:700">Global Chat</div>
        <div style="font-size:12px;color:var(--muted)" id="myName">not signed in</div>
      </div>

      <div class="messages" id="messages" aria-live="polite" role="log"></div>

      <div class="typing" id="typing"></div>

      <div class="controls">
        <input id="messageInput" class="message" placeholder="Type a message..." maxlength="1000" />
        <button id="sendBtn">Send</button>
        <button id="clearBtn" title="Clear local messages">Clear</button>
      </div>

      <div class="hint" style="margin-top:8px">
        Tip: to PM someone type <code>@username hello</code>. The last 100 messages are available when you join.
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    (() => {
      const socket = io();

      // DOM
      const usernameInput = document.getElementById('usernameInput');
      const setUsernameBtn = document.getElementById('setUsernameBtn');
      const usersList = document.getElementById('usersList');
      const messagesDiv = document.getElementById('messages');
      const myNameSpan = document.getElementById('myName');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const typingDiv = document.getElementById('typing');
      const clearBtn = document.getElementById('clearBtn');
      const onlineCount = document.getElementById('onlineCount');

      let myUsername = null;
      let typingTimer = null;

      function addSystem(text) {
        const div = document.createElement('div');
        div.className = 'system';
        div.textContent = text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addMessage(msg, options = {}) {
        const div = document.createElement('div');
        div.className = 'msg' + (options.me ? ' me' : '');
        const meta = document.createElement('div');
        meta.className = 'meta';
        const time = new Date(msg.time || Date.now());
        const ts = time.toLocaleTimeString();
        if (msg.system) {
          div.className = 'system';
          div.textContent = msg.text + ' — ' + ts;
          messagesDiv.appendChild(div);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
          return;
        }
        if (msg.private) {
          meta.textContent = `[PM] ${msg.from} → ${msg.to} · ${ts}`;
        } else {
          meta.textContent = `${msg.from} · ${ts}`;
        }
        const textEl = document.createElement('div');
        textEl.className = 'text';
        textEl.textContent = msg.text;
        div.appendChild(meta);
        div.appendChild(textEl);
        if (msg.private) {
          const badge = document.createElement('span');
          badge.className = 'private-badge';
          badge.textContent = 'private';
          meta.appendChild(badge);
        }
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function renderUsers(list) {
        usersList.innerHTML = '';
        list.forEach((u) => {
          const div = document.createElement('div');
          div.className = 'user';
          div.textContent = u;
          const btn = document.createElement('button');
          btn.textContent = 'PM';
          btn.style.padding = '6px';
          btn.style.fontSize = '12px';
          btn.onclick = () => {
            messageInput.value = `@${u} `;
            messageInput.focus();
          };
          div.appendChild(btn);
          usersList.appendChild(div);
        });
        onlineCount.textContent = list.length;
      }

      // Set username
      setUsernameBtn.addEventListener('click', () => {
        const candidate = usernameInput.value.trim();
        if (!candidate) return alert('enter a username');
        socket.emit('set username', candidate, (res) => {
          if (!res || !res.ok) {
            alert('Username failed: ' + (res && res.error ? res.error : 'unknown'));
            return;
          }
          myUsername = res.username;
          myNameSpan.textContent = 'you: ' + myUsername;
          usernameInput.value = '';
        });
      });

      usernameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') setUsernameBtn.click();
      });

      // Send message
      function sendMessage() {
        const txt = messageInput.value.trim();
        if (!txt) return;
        socket.emit('chat message', txt, (ack) => {
          if (!ack || !ack.ok) {
            // Could show UI error
            console.warn('msg not sent', ack);
          } else {
            // If local echo is needed for public messages, server will broadcast it back.
            // For PMs, we already receive the private message event back from the server.
          }
        });
        messageInput.value = '';
        socket.emit('typing', false);
      }

      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        } else {
          socket.emit('typing', true);
          clearTimeout(typingTimer);
          typingTimer = setTimeout(() => {
            socket.emit('typing', false);
          }, 800);
        }
      });

      clearBtn.addEventListener('click', () => {
        messagesDiv.innerHTML = '';
      });

      // Socket listeners
      socket.on('connect', () => {
        addSystem('Connected to server');
      });

      socket.on('disconnect', () => {
        addSystem('Disconnected from server');
        myNameSpan.textContent = 'not signed in';
        myUsername = null;
      });

      socket.on('history', (history) => {
        history.forEach(m => {
          if (m.system) addSystem(m.text);
          else addMessage(m, { me: m.from === myUsername });
        });
      });

      socket.on('users', (list) => {
        renderUsers(list);
      });

      socket.on('system message', (m) => {
        if (m && m.text) addSystem(m.text);
      });

      socket.on('chat message', (m) => {
        addMessage(m, { me: m.from === myUsername });
      });

      socket.on('private message', (m) => {
        addMessage(m, { me: m.from === myUsername });
      });

      socket.on('typing', (data) => {
        // show short typing indicator
        if (!data || !data.username) return;
        typingDiv.textContent = data.typing ? `${data.username} is typing…` : '';
      });

      // Minor UX: autofill username from localStorage
      const stored = localStorage.getItem('chat_username');
      if (stored) {
        usernameInput.value = stored;
      }

      // When server tells us our username was accepted, store
      // We'll intercept the success via set username callback above — store there too.
      const originalSet = setUsernameBtn.onclick;
      // store when we get a username successfully by listening to 'users' update only if myName is set
      // Simpler: when myName changes above, set localStorage
      const obs = new MutationObserver(() => {
        if (myUsername) localStorage.setItem('chat_username', myUsername);
      });
      obs.observe(myNameSpan, { childList: true, subtree: true });
    })();
  </script>
</body>
</html>
