<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Simple Poker Lobby & Table</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{ --bg:#071021; --card:#0b1220; --muted:#9aa7bb; --accent:#3b82f6; --txt:#ecf0f7;}
    body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#051021,#071426);color:var(--txt)}
    .wrap{max-width:1100px;margin:18px auto;padding:12px;display:grid;grid-template-columns:300px 1fr;gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;box-shadow:0 6px 22px rgba(1,8,20,0.6)}
    .sidebar h3{margin:0 0 8px 0}
    .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .seats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .seat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;min-height:72px;display:flex;flex-direction:column;justify-content:space-between}
    .seat .name{font-weight:700}
    .table-area{display:flex;flex-direction:column;height:80vh}
    .table-board{flex:0 0 260px;background:url('') center/cover no-repeat;border-radius:10px;padding:12px;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .community{display:flex;gap:8px;margin-bottom:10px}
    .card-spot{width:56px;height:80px;border-radius:6px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-weight:700}
    .hole{width:46px;height:66px;border-radius:6px;background:rgba(0,0,0,0.25);display:flex;align-items:center;justify-content:center;font-weight:700}
    .controls{display:flex;gap:8px;margin-top:8px}
    .players-list{display:flex;gap:8px;flex-wrap:wrap}
    .chat{height:200px;overflow:auto;padding:8px;background:rgba(0,0,0,0.1);border-radius:8px}
    .small{font-size:12px;color:var(--muted)}
    .center{display:flex;align-items:center;justify-content:center}
    .dealer-badge{background:#ffd54d;color:#111;padding:6px;border-radius:8px;font-weight:700}
    input[type="text"], input[type="number"]{padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--txt)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card sidebar">
      <h3>Lobby</h3>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="username" placeholder="username" />
        <button id="setname" class="btn">Set</button>
      </div>
      <div style="margin-bottom:8px">
        <button id="becomeOwner" class="btn">Become Table Owner</button>
      </div>
      <div style="margin-bottom:10px">
        <label class="small">Seat number (0-5)</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="seatNum" type="number" min="0" max="5" value="0" style="width:70px"/>
          <input id="buyIn" type="number" min="100" value="100" style="width:110px"/>
          <button id="sitBtn" class="btn">Sit</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <button id="standBtn" class="btn" style="background:#ef4444">Stand</button>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:10px 0"/>

      <div>
        <div class="small">Table Controls (owner)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="startHand" class="btn">Start Hand</button>
          <button id="kickBtn" class="btn" style="background:#ef4444">Kick</button>
        </div>
        <div style="margin-top:8px" class="small">Blinds: <span id="blindsText">10 / 20</span></div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:10px 0"/>
      <div>
        <div class="small">Chat</div>
        <div id="chat" class="chat"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="chatMsg" placeholder="say something" />
          <button id="sendChat" class="btn">Send</button>
        </div>
      </div>
    </div>

    <div class="card table-area">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><strong>Table</strong> <span class="small" id="tablePhase">idle</span></div>
        <div class="small">Pot: <span id="pot">0</span></div>
      </div>

      <div class="table-board card" style="height:260px">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
          <div id="dealerBadge" class="dealer-badge" style="display:none">D</div>
          <div style="font-weight:700" id="tableTitle">Texas Hold'em</div>
        </div>

        <div class="community" id="community">
          <div class="card-spot">--</div>
          <div class="card-spot">--</div>
          <div class="card-spot">--</div>
          <div class="card-spot">--</div>
          <div class="card-spot">--</div>
        </div>

        <div style="margin-top:6px" class="small">Dealer rotates each hand</div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Seats</div>
        <div class="seats" id="seats"></div>
      </div>

      <div style="margin-top:12px;display:flex;align-items:center;gap:8px;">
        <div class="small">Player actions</div>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <button id="foldBtn" class="btn">Fold</button>
          <button id="callBtn" class="btn">Check/Call</button>
          <input id="betAmount" type="number" min="1" value="20" style="width:90px"/>
          <button id="betBtn" class="btn">Bet/Raise</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Players / Seats</div>
        <div id="playersList" class="players-list"></div>
      </div>

    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // DOM
    const usernameInput = document.getElementById('username');
    const setnameBtn = document.getElementById('setname');
    const becomeOwnerBtn = document.getElementById('becomeOwner');
    const sitBtn = document.getElementById('sitBtn');
    const seatNumInput = document.getElementById('seatNum');
    const buyInInput = document.getElementById('buyIn');
    const standBtn = document.getElementById('standBtn');
    const startHandBtn = document.getElementById('startHand');
    const kickBtn = document.getElementById('kickBtn');

    const seatsDiv = document.getElementById('seats');
    const communityDiv = document.getElementById('community');
    const tablePhase = document.getElementById('tablePhase');
    const potSpan = document.getElementById('pot');
    const blindsText = document.getElementById('blindsText');
    const chatDiv = document.getElementById('chat');
    const chatMsg = document.getElementById('chatMsg');
    const sendChatBtn = document.getElementById('sendChat');
    const dealerBadge = document.getElementById('dealerBadge');
    const foldBtn = document.getElementById('foldBtn');
    const callBtn = document.getElementById('callBtn');
    const betBtn = document.getElementById('betBtn');
    const betAmountInput = document.getElementById('betAmount');
    const playersList = document.getElementById('playersList');

    let myUsername = null;
    let mySeat = null;
    let tableOwner = null;

    // simple chat
    sendChatBtn.onclick = () => {
      const t = chatMsg.value.trim();
      if (!t) return;
      socket.emit('chat', t);
      chatMsg.value = '';
    };

    socket.on('connect', () => {
      appendChat('Connected to server');
    });

    // set username
    setnameBtn.onclick = () => {
      const name = usernameInput.value.trim();
      if (!name) return alert('enter name');
      socket.emit('set username', name, (res) => {
        if (!res || !res.ok) return alert('error: ' + (res && res.error));
        myUsername = res.username;
        appendChat('username set: ' + myUsername);
      });
    };

    becomeOwnerBtn.onclick = () => {
      socket.emit('become owner', (res) => {
        if (!res || !res.ok) return alert('cant become owner');
        appendChat('you are table owner');
      });
    };

    sitBtn.onclick = () => {
      const seat = Number(seatNumInput.value);
      const buyIn = Number(buyInInput.value);
      socket.emit('sit', { seat, buyIn }, (res) => {
        if (!res || !res.ok) return alert('sit failed: ' + (res && res.error));
        appendChat('sat at ' + seat);
      });
    };

    standBtn.onclick = () => {
      socket.emit('stand', (res) => {
        appendChat('stood up');
      });
    };

    startHandBtn.onclick = () => {
      socket.emit('start hand', (res) => {
        if (!res || !res.ok) return alert('start failed: ' + (res && res.error));
        appendChat('hand started');
      });
    };

    kickBtn.onclick = () => {
      const s = Number(prompt('seat index to kick (0-5)'));
      if (isNaN(s)) return;
      socket.emit('kick', s, (res) => {
        appendChat('kick command sent');
      });
    };

    // actions
    foldBtn.onclick = () => socket.emit('action', { type: 'fold' }, (r)=>{});
    callBtn.onclick = () => socket.emit('action', { type: 'check_call' }, (r)=>{});
    betBtn.onclick = () => {
      const amt = Number(betAmountInput.value);
      socket.emit('action', { type: 'bet_raise', amount: amt }, (r)=>{ if (r && r.error) alert(r.error);});
    };

    // server-sent table state
    socket.on('table state', (t) => {
      // update UI
      tablePhase.textContent = t.phase;
      potSpan.textContent = t.pot || 0;
      blindsText.textContent = (t.smallBlind || 10) + ' / ' + (t.bigBlind || 20);
      // render community
      const com = t.community || [];
      const spots = communityDiv.querySelectorAll('.card-spot');
      for (let i=0;i<5;i++) {
        spots[i].textContent = com[i] || '--';
      }
      // render seats
      seatsDiv.innerHTML = '';
      playersList.innerHTML = '';
      mySeat = null;
      for (let i=0;i< (t.seats ? t.seats.length : 0); i++) {
        const s = t.seats[i];
        const div = document.createElement('div');
        div.className = 'seat';
        if (s) {
          const name = document.createElement('div'); name.className = 'name'; name.textContent = s.username;
          const chips = document.createElement('div'); chips.className='small'; chips.textContent = 'Chips: ' + s.chips;
          const seatInfo = document.createElement('div'); seatInfo.className='small'; seatInfo.textContent = 'Seat ' + i + (s.currentBet ? ' • Bet: ' + s.currentBet : '');
          div.appendChild(name); div.appendChild(chips); div.appendChild(seatInfo);
          // reveal hole only for owner of that seat
          if (s.hole) {
            const h = document.createElement('div'); h.style.display='flex'; h.style.gap='6px';
            for (const c of s.hole) {
              const el = document.createElement('div'); el.className='hole'; el.textContent = c;
              h.appendChild(el);
            }
            div.appendChild(h);
          }
          if (t.dealerIndex === i) {
            const d = document.createElement('div'); d.className='small'; d.textContent = 'Dealer';
            div.appendChild(d);
          }
          playersList.appendChild(div);
        } else {
          const empty = document.createElement('div');
          empty.className = 'small';
          empty.textContent = 'empty (seat ' + i + ')';
          div.appendChild(empty);
        }
        seatsDiv.appendChild(div);
      }
      // dealer badge
      if (t.dealerIndex !== null && t.seats[t.dealerIndex]) {
        dealerBadge.style.display = 'inline-block';
      } else dealerBadge.style.display = 'none';

      // show/hide owner controls
      // we can't easily know if we're the owner from client, but server includes owner id as socket id; the client cannot see socket id directly.
      // For simplicity: if my username matches owner username in seats mapping, assume owner (owner feature limited).
      // Not perfect: owner is socket id; we don't know mapping. We'll show owner controls always and server will reject unauthorized calls.
    });

    // chat messages (server doesn't implement chat routing in server.js above; just show locally)
    socket.on('lobby', (m) => {
      appendChat('Server: ' + (m.message || JSON.stringify(m)));
    });

    function appendChat(t) {
      const d = document.createElement('div');
      d.textContent = t;
      chatDiv.appendChild(d);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // debug prints
    socket.on('connect_error', (e) => appendChat('connect error: ' + e.message));
  </script>
</body>
</html>
