<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Sleek Hold'em — Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    /* Minimal sleek design */
    :root{
      --bg:#071426; --card:#0b1220; --muted:#9aa7bb; --accent:#06b6d4; --accent-2:#3b82f6; --text:#e6eef6;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#041223,#071426);color:var(--text);-webkit-font-smoothing:antialiased}
    .container{max-width:1200px;margin:18px auto;padding:12px;display:grid;grid-template-columns:320px 1fr;gap:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(2,8,20,0.6)}
    .sidebar h2{margin:0 0 10px 0}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px;align-items:center}
    input[type="text"], input[type="number"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    button{cursor:pointer;padding:8px 10px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041426;font-weight:700}
    .small{font-size:13px;color:var(--muted)}
    /* table area */
    .table-area{display:flex;flex-direction:column;height:78vh}
    .table-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .board{flex:0 0 260px;border-radius:12px;padding:14px;background:linear-gradient(180deg,#052233,#072a3a);display:flex;flex-direction:column;align-items:center;justify-content:center}
    .community{display:flex;gap:10px;margin-bottom:10px}
    .card-spot{width:64px;height:88px;border-radius:8px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px}
    .seats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .seat{padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));min-height:90px;display:flex;flex-direction:column;justify-content:space-between}
    .seat .name{font-weight:800}
    .seat .chips{color:var(--muted);font-size:13px}
    .hole-cards{display:flex;gap:6px;margin-top:8px}
    .hole{width:48px;height:64px;border-radius:6px;background:linear-gradient(180deg,#071426,#0b2740);display:flex;align-items:center;justify-content:center;font-weight:800}
    .actions{display:flex;gap:8px;align-items:center;margin-top:14px}
    .chat{height:120px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
    .players-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:700}
    @media (max-width:900px){ .container{grid-template-columns:1fr; padding:8px} .table-area{height:auto} .board{height:220px} }
  </style>
</head>
<body>
  <div class="container">
    <div class="card sidebar">
      <h2>Sleek Hold'em</h2>
      <div class="muted">Simple demo table. Owner controls start/reset hands.</div>

      <div style="margin-top:12px">
        <label class="small">Username</label>
        <div class="row" style="margin-top:6px">
          <input id="username" placeholder="Your name" />
          <button id="setNameBtn">Set</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="becomeOwnerBtn">Become Table Owner</button>
      </div>

      <div style="margin-top:12px">
        <label class="small">Sit at seat</label>
        <div class="row" style="margin-top:6px">
          <input id="seatIndex" type="number" min="0" max="5" value="0" style="width:80px"/>
          <input id="buyin" type="number" min="100" value="500" style="width:110px"/>
          <button id="sitBtn">Sit</button>
        </div>
        <div style="margin-top:8px">
          <button id="standBtn" style="background:#ef4444;color:white">Stand</button>
        </div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0"/>

      <div>
        <div class="small">Owner Controls</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="startHandBtn">Start Hand</button>
          <button id="kickBtn" style="background:#ef4444;color:white">Kick seat</button>
        </div>
        <div style="margin-top:8px" class="small">Blinds: <span id="blindsText">10 / 20</span></div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0"/>

      <div>
        <div class="small">Table chat</div>
        <div id="chatBox" class="chat"></div>
        <div class="row" style="margin-top:8px">
          <input id="chatInput" placeholder="Say something" />
          <button id="sendChatBtn">Send</button>
        </div>
      </div>
    </div>

    <div class="card table-area">
      <div class="table-top">
        <div>
          <div style="font-weight:900">Table • <span id="phase" class="muted">idle</span></div>
          <div class="small">Dealer: <span id="dealerIdx">-</span></div>
        </div>
        <div style="text-align:right">
          <div class="small">Pot</div>
          <div class="badge" id="potTotal">0</div>
        </div>
      </div>

      <div class="board card">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
          <div style="font-size:20px;font-weight:900">Community</div>
          <div class="small">(revealed when dealt)</div>
        </div>
        <div class="community" id="community">
          <div class="card-spot">--</div>
          <div class="card-spot">--</div>
          <div class="card-spot">--</div>
          <div class="card-spot">--</div>
          <div class="card-spot">--</div>
        </div>
        <div class="small">Dealer rotates each hand</div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Seats</div>
        <div class="seats-grid" id="seatsGrid"></div>
      </div>

      <div class="actions">
        <div class="small">Actions</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="foldBtn" style="background:#ef4444;color:white">Fold</button>
          <button id="callBtn">Check/Call</button>
          <input id="raiseAmt" type="number" value="50" style="width:100px;padding:8px;border-radius:8px"/>
          <button id="raiseBtn">Bet/Raise</button>
          <button id="allinBtn" style="background:#ffd54d">All-in</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="small">Players</div>
        <div id="playersList" class="players-list"></div>
      </div>
    </div>
  </div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // Client-side logic
  const socket = io();

  // DOM refs
  const setNameBtn = document.getElementById('setNameBtn');
  const usernameInput = document.getElementById('username');
  const becomeOwnerBtn = document.getElementById('becomeOwnerBtn');
  const seatIndexInput = document.getElementById('seatIndex');
  const buyinInput = document.getElementById('buyin');
  const sitBtn = document.getElementById('sitBtn');
  const standBtn = document.getElementById('standBtn');
  const startHandBtn = document.getElementById('startHandBtn');
  const kickBtn = document.getElementById('kickBtn');
  const blindsText = document.getElementById('blindsText');
  const chatBox = document.getElementById('chatBox');
  const chatInput = document.getElementById('chatInput');
  const sendChatBtn = document.getElementById('sendChatBtn');

  const communityDiv = document.getElementById('community');
  const seatsGrid = document.getElementById('seatsGrid');
  const phaseSpan = document.getElementById('phase');
  const dealerIdxSpan = document.getElementById('dealerIdx');
  const potTotalSpan = document.getElementById('potTotal');
  const playersList = document.getElementById('playersList');

  const foldBtn = document.getElementById('foldBtn');
  const callBtn = document.getElementById('callBtn');
  const raiseBtn = document.getElementById('raiseBtn');
  const raiseAmtInput = document.getElementById('raiseAmt');
  const allinBtn = document.getElementById('allinBtn');

  let myUsername = null;
  let mySeat = null;
  let lastState = null;

  function appendChat(msg) {
    const d = document.createElement('div');
    d.textContent = msg;
    chatBox.appendChild(d);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  setNameBtn.onclick = () => {
    const name = usernameInput.value.trim();
    if (!name) return alert('enter name');
    socket.emit('set username', name, res => {
      if (!res || !res.ok) return alert('error: ' + (res && res.error));
      myUsername = res.username;
      appendChat('You are: ' + myUsername);
    });
  };

  becomeOwnerBtn.onclick = () => {
    socket.emit('become owner', res => {
      if (!res || !res.ok) return alert('cannot become owner');
      appendChat('You are owner now (server enforces permissions).');
    });
  };

  sitBtn.onclick = () => {
    const seat = Number(seatIndexInput.value);
    const buyin = Number(buyinInput.value);
    socket.emit('sit', { seat, buyIn: buyin }, res => {
      if (!res || !res.ok) return alert('sit failed: ' + (res && res.error));
    });
  };

  standBtn.onclick = () => {
    socket.emit('stand', res => {
      appendChat('Stood up');
    });
  };

  startHandBtn.onclick = () => {
    socket.emit('start hand', res => {
      if (!res || !res.ok) return alert('start failed: ' + (res && res.error));
    });
  };

  kickBtn.onclick = () => {
    const s = Number(prompt('Seat to kick (0-5)'));
    if (isNaN(s)) return;
    socket.emit('kick', s, res => { appendChat('Kick requested'); });
  };

  sendChatBtn.onclick = () => {
    const txt = chatInput.value.trim();
    if (!txt) return;
    socket.emit('chat', txt);
    chatInput.value = '';
  };

  // actions
  foldBtn.onclick = () => {
    socket.emit('action', { type: 'fold' }, res => { if (res && res.error) alert(res.error); });
  };
  callBtn.onclick = () => {
    socket.emit('action', { type: 'call' }, res => { if (res && res.error) alert(res.error); });
  };
  raiseBtn.onclick = () => {
    const amt = Number(raiseAmtInput.value);
    if (isNaN(amt) || amt <= 0) return alert('invalid amount');
    socket.emit('action', { type: 'raise', amount: amt }, res => { if (res && res.error) alert(res.error); });
  };
  allinBtn.onclick = () => {
    if (!confirm('Go all-in?')) return;
    socket.emit('action', { type: 'allin' }, res => { if (res && res.error) alert(res.error); });
  };

  // render state
  function renderState(s) {
    lastState = s;
    phaseSpan.textContent = s.phase;
    dealerIdxSpan.textContent = (s.dealer === -1 ? '-' : s.dealer);
    potTotalSpan.textContent = s.potTotal || 0;
    blindsText.textContent = (s.smallBlind || 10) + ' / ' + (s.bigBlind || 20);

    // community
    const com = s.community || [];
    const spots = communityDiv.children;
    for (let i = 0; i < 5; i++) spots[i].textContent = com[i] || '--';

    // seats
    seatsGrid.innerHTML = '';
    playersList.innerHTML = '';
    mySeat = null;
    for (let i = 0; i < (s.seats ? s.seats.length : 0); i++) {
      const seat = s.seats[i];
      const div = document.createElement('div');
      div.className = 'seat';
      if (seat) {
        const name = document.createElement('div'); name.className = 'name'; name.textContent = seat.username + (seat.id ? (' • ' + seat.id.slice(0,4)) : '');
        const chips = document.createElement('div'); chips.className = 'chips'; chips.textContent = 'Chips: ' + seat.chips;
        const contribution = document.createElement('div'); contribution.className = 'small'; contribution.textContent = 'Contrib: ' + (seat.contribution || 0);
        div.appendChild(name); div.appendChild(chips); div.appendChild(contribution);
        // hole cards
        if (seat.hole) {
          const hwrap = document.createElement('div'); hwrap.className = 'hole-cards';
          for (const c of seat.hole) {
            const hc = document.createElement('div'); hc.className = 'hole'; hc.textContent = c;
            hwrap.appendChild(hc);
          }
          div.appendChild(hwrap);
        }
        // dealer badge
        if (s.dealer === i) {
          const d = document.createElement('div'); d.className = 'small'; d.textContent = 'Dealer';
          div.appendChild(d);
        }
        // current bet indicator
        if (seat.currentBet && seat.currentBet > 0) {
          const cb = document.createElement('div'); cb.className = 'small'; cb.textContent = 'Bet: ' + seat.currentBet;
          div.appendChild(cb);
        }
        // add to players list
        const pl = document.createElement('div'); pl.className = 'badge'; pl.textContent = seat.username + ' (' + seat.chips + ')';
        playersList.appendChild(pl);
      } else {
        const empty = document.createElement('div'); empty.className = 'small'; empty.textContent = 'Empty (seat ' + i + ')';
        div.appendChild(empty);
      }
      seatsGrid.appendChild(div);
      // detect my seat
      if (seat && seat.id && localStorage.getItem('mySeatId') === seat.id) mySeat = i;
      if (seat && seat.socketId === socket.id) mySeat = i;
    }

    // highlight current turn by enabling/disabling action buttons
    if (s.currentTurnSeat !== null && s.currentTurnSeat !== undefined) {
      if (s.currentTurnSeat === mySeat) {
        foldBtn.disabled = false; callBtn.disabled = false; raiseBtn.disabled = false; allinBtn.disabled = false;
      } else {
        foldBtn.disabled = true; callBtn.disabled = true; raiseBtn.disabled = true; allinBtn.disabled = true;
      }
    } else {
      foldBtn.disabled = true; callBtn.disabled = true; raiseBtn.disabled = true; allinBtn.disabled = true;
    }
  }

  // initialize board spots
  (function initBoard() {
    communityDiv.innerHTML = '';
    for (let i = 0; i < 5; i++) {
      const sp = document.createElement('div'); sp.className = 'card-spot'; sp.textContent = '--';
      communityDiv.appendChild(sp);
    }
  })();

  socket.on('state', (s) => {
    renderState(s);
  });

  socket.on('welcome', (m) => {
    appendChat('Connected — socket id assigned');
  });

  socket.on('chat', (m) => {
    appendChat((m.from || 'anon') + ': ' + m.text);
  });

  socket.on('connect_error', (e) => appendChat('connect error: ' + e.message));

  // store seat id locally to re-identify owner seat
  // Note: server gives seat.id to client in seat info; we preserve if sitting
  // Save after every state update
  (function patchLocalSeatTracker() {
    const origRender = renderState;
    renderState = function(s) {
      origRender(s);
      // find seat that belongs to me by matching socket id (server would show socketId only on seats owning current client? Not included)
      if (!s.seats) return;
      for (const seat of s.seats) {
        if (!seat) continue;
        // heuristic: if username equals stored username and no id mismatch, try store id
        const storedName = localStorage.getItem('myUsername');
        if (storedName && seat.username === storedName && seat.id) {
          localStorage.setItem('mySeatId', seat.id);
        }
      }
    };
  })();

  // persist username
  usernameInput.value = localStorage.getItem('myUsername') || '';
  setNameBtn.onclick = () => {
    const name = usernameInput.value.trim();
    if (!name) return alert('enter name');
    socket.emit('set username', name, res => {
      if (res && res.ok) {
        localStorage.setItem('myUsername', name);
        myUsername = name;
        appendChat('username set: ' + name);
      }
    });
  };

  // restore if we had seatId prior
  const existingSeatId = localStorage.getItem('mySeatId');
  if (existingSeatId) appendChat('Remembered seat id: ' + existingSeatId);

</script>
</body>
</html>
